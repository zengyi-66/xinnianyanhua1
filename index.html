<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>2025 æ–°å¹´ç§äººå®šåˆ¶çƒŸèŠ±</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: "Microsoft YaHei", Arial, sans-serif;
            touch-action: none; 
        }
        canvas { display: block; }
        #textCanvas { display: none; }

        /* === UI ç•Œé¢ (ä¿®å¤ç‰ˆï¼šå¢åŠ æ»šåŠ¨æ¡é˜²æ­¢æŒ‰é’®è¢«æŒ¡ä½) === */
        #setup-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; /* é»˜è®¤å±…ä¸­ */
            color: #ffd700;
            transition: opacity 0.5s;
            overflow-y: auto; /* å…³é”®ï¼šå…è®¸å‚ç›´æ»šåŠ¨ */
            padding: 20px 0;  /* é˜²æ­¢ä¸Šä¸‹è´´è¾¹ */
        }
        #setup-screen.hidden { opacity: 0; pointer-events: none; }

        .setup-title {
            font-size: 40px;
            margin: 20px 0; font-weight: bold;
            text-shadow: 0 0 25px #ffd700; letter-spacing: 5px;
            font-family: "Microsoft YaHei", serif;
            color: #ffd700;
            text-align: center;
            flex-shrink: 0; /* é˜²æ­¢æ ‡é¢˜è¢«å‹ç¼© */
        }

        .setup-group {
            background: rgba(255, 215, 0, 0.05);
            padding: 15px; border-radius: 15px; border: 1px solid rgba(255, 215, 0, 0.3);
            width: 85%; max-width: 400px; margin-bottom: 15px; text-align: center;
            flex-shrink: 0;
        }
        .setup-label { font-size: 14px; margin-bottom: 10px; display: block; color: #ffe6a0; }

        textarea {
            width: 90%;
            height: 80px;
            background: rgba(0, 0, 0, 0.6); border: 1px solid #ffd700;
            color: #ffd700; font-size: 16px; padding: 10px;
            border-radius: 5px;
            outline: none; resize: none;
            font-family: "Microsoft YaHei"; text-align: center;
        }
        textarea::placeholder { color: rgba(255, 215, 0, 0.3); }

        /* === æŒ‰é’®å®¹å™¨ (ä¿®å¤ï¼šç¡®ä¿æ¨ªæ’æ˜¾ç¤º) === */
        .btn-box {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            margin-bottom: 30px; /* åº•éƒ¨ç•™ç™½ */
            flex-wrap: wrap; /* å±å¹•å¤ªçª„è‡ªåŠ¨æ¢è¡Œ */
            flex-shrink: 0;
        }

        /* ç»¿è‰²åˆ†äº«æŒ‰é’® */
        #share-btn {
            padding: 12px 25px;
            font-size: 16px; color: #fff; 
            background: linear-gradient(45deg, #07c160, #10ad63); /* å¾®ä¿¡ç»¿ */
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 15px rgba(7, 193, 96, 0.4);
            font-weight: bold; 
            font-family: "Microsoft YaHei";
            display: flex; align-items: center; gap: 5px;
        }

        /* é‡‘è‰²å¼€å§‹æŒ‰é’® */
        #start-btn {
            padding: 12px 40px;
            font-size: 18px; color: #000; 
            background: linear-gradient(45deg, #ffd700, #ffec8b, #b8860b);
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            font-weight: bold; 
            font-family: "Microsoft YaHei";
        }
        
        button:active { transform: scale(0.95); }

        /* ä¾§è¾¹æ å’ŒçŠ¶æ€æ  */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        #sidebar { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; pointer-events: auto; }
        
        .mini-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0,0,0,0.6); border: 1px solid #ffd700;
            color: #ffd700; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; user-select: none;
        }
        
        #status {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            color: rgba(255, 215, 0, 0.6); font-size: 12px;
        }
        
        .file-upload { 
            position: relative; display: inline-block; cursor: pointer; 
            color: #ffe6a0; border: 1px solid #ffd700; padding: 6px 20px; border-radius: 20px; 
            font-size: 14px;
        }
        .file-upload input { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>
<canvas id="textCanvas"></canvas>
<audio id="bgm" loop hidden></audio>

<div id="setup-screen">
    <div class="setup-title">2025 å®šåˆ¶çƒŸèŠ±</div>
    
    <div class="setup-group">
        <span class="setup-label">âœï¸ è¾“å…¥ç¥ç¦è¯­ (æ¯è¡Œä¸€å¥)</span>
        <textarea id="setup-text" placeholder="ç¥å¤§å®¶æ–°å¹´å¿«ä¹&#10;è›‡å¹´å¤§å‰å¤§åˆ©&#10;èº«ä½“å¥åº· ä¸‡äº‹å¦‚æ„"></textarea>
    </div>

    <div class="setup-group">
        <span class="setup-label">ğŸµ èƒŒæ™¯éŸ³ä¹ (å¯é€‰)</span>
        <div class="file-upload">
            <span id="music-label">ğŸ“ ä¸Šä¼  MP3</span>
            <input type="file" id="setup-music" accept="audio/*">
        </div>
    </div>

    <div class="btn-box">
        <button id="share-btn">ğŸ”— å¤åˆ¶é“¾æ¥é€ç¥ç¦</button>
        <button id="start-btn">ğŸš€ å¼€å§‹æ’­æ”¾</button>
    </div>
    
    <div style="color: #666; font-size: 12px; margin-bottom: 20px;">
        * ç‚¹å‡»â€œå¤åˆ¶é“¾æ¥â€åï¼Œå¯å‘é€ç»™å¾®ä¿¡å¥½å‹
    </div>
</div>

<div id="ui-layer">
    <div id="sidebar">
        <div class="mini-btn" title="å…¨å±" onclick="toggleFullscreen()">â›¶</div>
        <div class="mini-btn" title="ç¼–è¾‘" onclick="showSetup()">âœ</div>
        <div class="mini-btn" title="é‡æ’­" onclick="replay()">â†»</div>
    </div>
    <div id="status"></div>
</div>

<script>
    // === V30 æ ¸å¿ƒé…ç½® ===
    const CONFIG = {
        textBaseHue: 50, textBrightness: 100, gap: 3, 
        textRocketSpeed: 14, ambienceRocketMin: 12, ambienceRocketMax: 20, 
        textFriction: 0.90, gravity: 0.04, trail: 0.12,            
        rocketWidthText: 8, rocketWidthAmbience: 5, 
        ambienceInterval: 30, partyInterval: 8, launchInterval: 1200 
    };
    const MAX_PARTICLES = 6000; 

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const textCanvas = document.getElementById('textCanvas');
    const textCtx = textCanvas.getContext('2d');
    let cw = window.innerWidth;
    let ch = window.innerHeight;
    
    let fireworks = [];
    let particles = [];
    const SYSTEM_COUNTDOWN = ['10', '9', '8', '7', '6', '5', '4', '3', '2', '1'];
    const DEFAULT_MSG = ['2025', 'è›‡å¹´å¤§å‰', 'æ–°å¹´å¿«ä¹', 'ä¸‡äº‹å¦‚æ„']; 
    
    let playList = [];
    let currentIndex = 0;
    let lastTextLaunchTime = 0;
    let tick = 0;
    let isRunning = false;
    let isFinished = false;

    function resize() {
        cw = canvas.width = window.innerWidth;
        ch = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    window.toggleFullscreen = function() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => console.log(err));
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    };

    // === ã€åŠŸèƒ½ã€‘è¯»å– URL ä¸­çš„ ?msg=... å‚æ•° ===
    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const msg = params.get('msg');
        if (msg) {
            try {
                // è§£ç å¹¶å¡«å……åˆ°æ–‡æœ¬æ¡†
                const decodedMsg = decodeURIComponent(msg);
                document.getElementById('setup-text').value = decodedMsg;
                // ä¿®æ”¹æ ‡é¢˜è®©ç”¨æˆ·çŸ¥é“è¿™æ˜¯å®šåˆ¶çš„
                document.querySelector('.setup-title').innerText = "æ”¶åˆ°ä¸€ä»½ä¸“å±ç¥ç¦";
                document.querySelector('.setup-title').style.color = "#ff4d4d"; // çº¢è‰²æ ‡é¢˜
            } catch(e) {
                console.error("URLè§£ç å¤±è´¥", e);
            }
        }
    }
    checkUrlParams();

    // === çƒŸèŠ±æ ¸å¿ƒé€»è¾‘ (ä¿ç•™V30åŸç‰ˆ) ===
    function getTextPoints(text) {
        textCanvas.width = cw;
        textCanvas.height = ch;
        textCtx.clearRect(0, 0, cw, ch);
        
        let baseSize = Math.min(cw * 0.22, 250); 
        if (text.length > 2) baseSize = Math.min(cw * 0.18, 200);
        if (text.length > 5) baseSize = Math.min(cw * 0.12, 150);
        
        textCtx.font = "bold " + baseSize + "px Arial, sans-serif";
        textCtx.fillStyle = '#ffffff';
        textCtx.textAlign = 'center';
        textCtx.textBaseline = 'middle';
        textCtx.fillText(text, cw / 2, ch / 3); 

        let imgData = textCtx.getImageData(0, 0, cw, ch).data;
        let points = [];
        let dynamicGap = CONFIG.gap;
        if (text.length > 4) dynamicGap = 3; 
        
        for (let y = 0; y < ch; y += dynamicGap) {
            for (let x = 0; x < cw; x += dynamicGap) {
                let i = (y * cw + x) * 4;
                if (imgData[i + 3] > 128) { 
                    points.push({x: x, y: y});
                }
            }
        }
        return points;
    }

    function random(min, max) { return Math.random() * (max - min) + min; }
    function getDistance(x1, y1, x2, y2) { return Math.sqrt(Math.pow(x1-x2, 2) + Math.pow(y1-y2, 2)); }

    class Firework {
        constructor(text, startX) {
            if (startX !== undefined) this.x = startX;
            else this.x = random(cw * 0.1, cw * 0.9);
            this.y = ch;
            this.tx = this.x + random(-20, 20);
            this.ty = random(ch * 0.1, ch * 0.35); 
            
            if (text) {
                this.x = cw / 2;
                this.tx = cw / 2;
                this.ty = ch / 3;
                this.speed = CONFIG.textRocketSpeed;
                this.textPayload = text;
                this.isTextRocket = true;
                this.lineWidth = CONFIG.rocketWidthText;
                this.hue = random(CONFIG.textBaseHue - 5, CONFIG.textBaseHue + 5);
                this.brightness = CONFIG.textBrightness;
            } else {
                this.speed = random(CONFIG.ambienceRocketMin, CONFIG.ambienceRocketMax);
                this.textPayload = null;
                this.isTextRocket = false;
                this.lineWidth = random(3, 6); 
                this.hue = random(0, 360);
                this.brightness = random(50, 80);
                this.explosionType = Math.floor(random(0, 3));
            }

            this.distToTarget = getDistance(this.x, this.y, this.tx, this.ty);
            this.distTraveled = 0;
            this.coordinates = [];
            this.coordinateCount = 3;
            while(this.coordinateCount--) this.coordinates.push([this.x, this.y]);
            this.angle = Math.atan2(this.ty - this.y, this.tx - this.x);
            this.acceleration = 1.015;
        }

        update(index) {
            this.coordinates.pop();
            this.coordinates.unshift([this.x, this.y]);
            this.speed *= this.acceleration;
            let vx = Math.cos(this.angle) * this.speed;
            let vy = Math.sin(this.angle) * this.speed;
            this.distTraveled = getDistance(this.x, this.y, this.x + vx, this.y + vy) + this.distTraveled;
            
            if (this.distTraveled >= this.distToTarget) {
                createParticles(this.tx, this.ty, this.textPayload, this.hue, this.explosionType);
                fireworks.splice(index, 1);
            } else {
                this.x += vx;
                this.y += vy;
            }
        }

        draw() {
            ctx.beginPath();
            ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
            ctx.lineTo(this.x, this.y);
            ctx.lineWidth = this.lineWidth;
            ctx.strokeStyle = `hsl(${this.hue}, 100%, 60%)`;
            ctx.stroke();
            ctx.lineWidth = 1;
        }
    }

    class Particle {
        constructor(x, y, hue, type, targetX, targetY, isNumber = false) {
            this.x = x;
            this.y = y;
            this.coordinates = [];
            this.coordinateCount = 5; 
            while(this.coordinateCount--) this.coordinates.push([this.x, this.y]);
            
            this.hue = hue;
            this.alpha = 1;
            this.type = type;

            if (type === 'text') {
                this.x = targetX;
                this.y = targetY;
                this.vx = random(-0.8, 0.8);
                this.vy = random(-0.8, 0.8);
                this.friction = CONFIG.textFriction;
                this.gravity = 0.03;
                this.decay = isNumber ? random(0.025, 0.035) : random(0.010, 0.015);
                this.brightness = CONFIG.textBrightness;
            } else {
                let angle = random(0, Math.PI * 2);
                let speed = random(3, 15); 
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.friction = 0.96;
                this.gravity = 0.04;
                this.decay = random(0.015, 0.025);
                this.brightness = random(50, 80);
            }
        }

        update(index) {
            this.coordinates.pop();
            this.coordinates.unshift([this.x, this.y]);
            this.vx *= this.friction;
            this.vy *= this.friction;
            this.vy += this.gravity;
            this.x += this.vx;
            this.y += this.vy;
            this.alpha -= this.decay;
            if (this.alpha <= this.decay) particles.splice(index, 1);
        }

        draw() {
            ctx.beginPath();
            ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
            ctx.lineTo(this.x, this.y);
            ctx.lineWidth = (this.type === 'text') ? 3 : 2;
            
            if (this.type === 'text') {
                ctx.strokeStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`;
            } else {
                ctx.strokeStyle = `hsla(${this.hue}, 100%, 60%, ${this.alpha})`;
            }
            ctx.stroke();
        }
    }

    function createParticles(x, y, text, hue, type) {
        if (text) {
            let points = getTextPoints(text);
            let isNumber = !isNaN(text);
            if (particles.length > MAX_PARTICLES) return;
            let limit = 5000; 
            let step = Math.max(1, Math.ceil(points.length / limit));
            for(let i=0; i<points.length; i+=step) {
                particles.push(new Particle(x, y, hue, 'text', points[i].x, points[i].y, isNumber));
            }
        } else {
            let count = 100;
            while(count--) {
                particles.push(new Particle(x, y, hue, type, 0, 0));
            }
        }
    }

    // === UI äº¤äº’é€»è¾‘ ===
    const setupScreen = document.getElementById('setup-screen');
    const setupText = document.getElementById('setup-text');
    const setupMusic = document.getElementById('setup-music');
    const musicLabel = document.getElementById('music-label');
    const startBtn = document.getElementById('start-btn');
    const shareBtn = document.getElementById('share-btn');
    const bgm = document.getElementById('bgm');

    setupMusic.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            musicLabel.innerText = "âœ… " + file.name;
            bgm.src = URL.createObjectURL(file);
        }
    });

    startBtn.addEventListener('click', () => {
        initPlayList();
        if (bgm.src) {
            bgm.play().catch(e => console.log("ç­‰å¾…äº¤äº’æ’­æ”¾"));
        }
        setupScreen.classList.add('hidden');
        isRunning = true;
        document.getElementById('status').innerText = "âœ¨ æ­£åœ¨æ’­æ”¾ç§äººå®šåˆ¶çƒŸèŠ± âœ¨";
    });

    // === ã€æ ¸å¿ƒä¿®å¤ã€‘ç”Ÿæˆå¹¶å¤åˆ¶é“¾æ¥ ===
    shareBtn.addEventListener('click', () => {
        const text = setupText.value.trim();
        if (!text) {
            alert("è¯·å…ˆè¾“å…¥ä¸€äº›ç¥ç¦è¯­å†åˆ†äº«ï¼");
            return;
        }
        
        // 1. ç”Ÿæˆé“¾æ¥
        const baseUrl = window.location.origin + window.location.pathname;
        const encodedMsg = encodeURIComponent(text);
        const shareUrl = `${baseUrl}?msg=${encodedMsg}`;
        
        // 2. å¤åˆ¶é€»è¾‘
        const copyToClipboard = (str) => {
            const el = document.createElement('textarea');
            el.value = str;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        };

        try {
            if (navigator.clipboard && window.isSecureContext) {
                 navigator.clipboard.writeText(shareUrl).then(() => {
                    alert("âœ… é“¾æ¥å·²å¤åˆ¶æˆåŠŸï¼\n\nå¿«å»å¾®ä¿¡å‘é€ç»™æœ‹å‹å§ï¼\næœ‹å‹ç‚¹å¼€å°±èƒ½çœ‹åˆ°ï¼š" + text);
                 }, () => {
                    copyToClipboard(shareUrl);
                    alert("âœ… é“¾æ¥å·²å¤åˆ¶ï¼\n\nè¯·ç›´æ¥ç²˜è´´å‘ç»™æœ‹å‹ã€‚");
                 });
            } else {
                copyToClipboard(shareUrl);
                alert("âœ… é“¾æ¥å·²å¤åˆ¶æˆåŠŸï¼\n\nè¯·ç›´æ¥å»å¾®ä¿¡ç²˜è´´å‘é€ç»™æœ‹å‹ã€‚");
            }
        } catch (err) {
            prompt("å¤åˆ¶è‡ªåŠ¨å¤±è´¥ï¼Œè¯·é•¿æŒ‰ä¸‹æ–¹é“¾æ¥å¤åˆ¶ï¼š", shareUrl);
        }
    });

    window.showSetup = function() {
        setupScreen.classList.remove('hidden');
        isRunning = false; 
    };

    window.replay = function() {
        initPlayList();
        fireworks = [];
        document.getElementById('status').innerText = "âœ¨ é‡æ–°æ’­æ”¾ âœ¨";
    };

    function initPlayList() {
        const rawText = setupText.value.trim();
        currentIndex = 0;
        isFinished = false;
        if (rawText) {
            let userList = rawText.split('\n').filter(t => t.trim() !== '');
            if (isNaN(parseInt(userList[0]))) {
                playList = SYSTEM_COUNTDOWN.concat(userList);
            } else {
                playList = userList;
            }
        } else {
            playList = SYSTEM_COUNTDOWN.concat(DEFAULT_MSG);
        }
    }

    function loop() {
        requestAnimationFrame(loop);
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = `rgba(0, 0, 0, ${CONFIG.trail})`;
        ctx.fillRect(0, 0, cw, ch);
        ctx.globalCompositeOperation = 'lighter';

        let i = fireworks.length;
        while(i--) { fireworks[i].draw(); fireworks[i].update(i); }
        let j = particles.length;
        while(j--) { particles[j].draw(); particles[j].update(j); }

        if (particles.length > MAX_PARTICLES) {
            particles.splice(0, particles.length - MAX_PARTICLES);
        }

        if (!isRunning) return;

        let now = Date.now();
        tick++;
        if (!isFinished) {
            let waitTime = CONFIG.launchInterval;
            if (currentIndex >= 10) waitTime += 900; 

            if (now - lastTextLaunchTime > waitTime) { 
                if (currentIndex < playList.length) {
                    let text = playList[currentIndex];
                    fireworks.push(new Firework(text));
                    currentIndex++;
                    lastTextLaunchTime = now;
                } else {
                    isFinished = true; 
                }
            }
            if (tick >= CONFIG.ambienceInterval) {
                fireworks.push(new Firework(null, random(cw * 0.05, cw * 0.15)));
                fireworks.push(new Firework(null, random(cw * 0.85, cw * 0.95)));
                tick = 0;
            }
        } else {
            if (tick >= CONFIG.partyInterval) {
                let count = Math.floor(random(2, 4));
                for(let k=0; k<count; k++){
                    fireworks.push(new Firework(null, undefined));
                }
                tick = 0;
            }
        }
    }

    loop();

    // === äº¤äº’æ”¯æŒ (ä¿®å¤ç”µè„‘é¼ æ ‡) ===
    function handleInput(x, y) {
        if (!isRunning) return; 
        fireworks.push(new Firework(null, x)); 
    }
    canvas.addEventListener('mousedown', (e) => handleInput(e.clientX, e.clientY));
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        for (let i = 0; i < e.touches.length; i++) {
            handleInput(e.touches[i].clientX, e.touches[i].clientY);
        }
    }, {passive: false});

</script>
</body>
</html>
