<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>2025 æ–°å¹´ç§äººå®šåˆ¶çƒŸèŠ±</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: "Microsoft YaHei", Arial, sans-serif;
            touch-action: none; 
        }
        canvas { display: block; }
        #textCanvas { display: none; }

        /* === UI ç•Œé¢ === */
        #setup-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: #ffd700;
            transition: opacity 0.5s;
        }
        #setup-screen.hidden { opacity: 0; pointer-events: none; }

        .setup-title {
            font-size: 40px; /* ç¨å¾®è°ƒå°é€‚é…æ‰‹æœº */
            margin-bottom: 20px; font-weight: bold;
            text-shadow: 0 0 25px #ffd700; letter-spacing: 5px;
            font-family: "Microsoft YaHei", serif;
            color: #ffd700;
            text-align: center;
        }

        .setup-group {
            background: rgba(255, 215, 0, 0.05);
            padding: 15px; border-radius: 15px; border: 1px solid rgba(255, 215, 0, 0.3);
            width: 90%; max-width: 400px; margin-bottom: 15px; text-align: center;
        }
        .setup-label { font-size: 14px; margin-bottom: 10px; display: block; color: #ffe6a0; }

        textarea {
            width: 90%;
            height: 80px;
            background: rgba(0, 0, 0, 0.6); border: 1px solid #ffd700;
            color: #ffd700; font-size: 16px; padding: 10px;
            border-radius: 5px;
            outline: none; resize: none;
            font-family: "Microsoft YaHei"; text-align: center;
        }
        textarea::placeholder { color: rgba(255, 215, 0, 0.3); }

        /* æŒ‰é’®å®¹å™¨ */
        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            justify-content: center;
        }

        /* å¼€å§‹æŒ‰é’® */
        #start-btn {
            padding: 12px 30px;
            font-size: 18px; color: #000; 
            background: linear-gradient(45deg, #ffd700, #ffec8b, #b8860b);
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            font-weight: bold; 
            font-family: "Microsoft YaHei";
        }
        
        /* ã€æ–°å¢ã€‘ç”Ÿæˆé“¾æ¥æŒ‰é’® */
        #share-btn {
            padding: 12px 30px;
            font-size: 18px; color: #fff; 
            background: linear-gradient(45deg, #09bb07, #4ae048); /* å¾®ä¿¡ç»¿ */
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 20px rgba(9, 187, 7, 0.4);
            font-weight: bold; 
            font-family: "Microsoft YaHei";
        }

        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        #sidebar { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; pointer-events: auto; }
        
        .mini-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0,0,0,0.6); border: 1px solid #ffd700;
            color: #ffd700; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; user-select: none;
        }
        
        #status {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            color: rgba(255, 215, 0, 0.6); font-size: 12px;
        }
        
        .file-upload { 
            position: relative; display: inline-block; cursor: pointer; 
            color: #ffe6a0; border: 1px solid #ffd700; padding: 6px 20px; border-radius: 20px; 
            font-size: 14px;
        }
        .file-upload input { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>
<canvas id="textCanvas"></canvas>
<audio id="bgm" loop hidden></audio>

<div id="setup-screen">
    <div class="setup-title">2025 å®šåˆ¶çƒŸèŠ±</div>
    
    <div class="setup-group">
        <span class="setup-label">âœï¸ å†™ä¸‹ç¥ç¦ï¼Œç”Ÿæˆé“¾æ¥å‘ç»™æœ‹å‹</span>
        <textarea id="setup-text" placeholder="åœ¨æ­¤è¾“å…¥ç¥ç¦è¯­...&#10;ä¾‹å¦‚ï¼šå¼ ä¸‰ ç¥ æå›› æ–°å¹´å¿«ä¹"></textarea>
    </div>

    <div class="setup-group">
        <span class="setup-label">ğŸµ èƒŒæ™¯éŸ³ä¹ (å¯é€‰)</span>
        <div class="file-upload">
            <span id="music-label">ä¸Šä¼  MP3</span>
            <input type="file" id="setup-music" accept="audio/*">
        </div>
    </div>

    <div class="btn-container">
        <button id="share-btn">ğŸ“‹ ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
        <button id="start-btn">ğŸš€ ç›´æ¥æ’­æ”¾</button>
    </div>
    
    <div style="margin-top:15px; color:#666; font-size:12px;">
        *ç‚¹å‡»"ç”Ÿæˆåˆ†äº«é“¾æ¥"åï¼Œç›´æ¥å»å¾®ä¿¡ç²˜è´´å³å¯
    </div>
</div>

<div id="ui-layer">
    <div id="sidebar">
        <div class="mini-btn" title="å…¨å±" onclick="toggleFullscreen()">â›¶</div>
        <div class="mini-btn" title="ç¼–è¾‘" onclick="showSetup()">âœ</div>
        <div class="mini-btn" title="é‡æ’­" onclick="replay()">â†»</div>
    </div>
    <div id="status"></div>
</div>

<script>
    // === æ ¸å¿ƒå‚æ•° ===
    const CONFIG = {
        textBaseHue: 50, textBrightness: 100, gap: 3, 
        textRocketSpeed: 14, ambienceRocketMin: 12, ambienceRocketMax: 20, 
        textFriction: 0.90, gravity: 0.04, trail: 0.12,            
        rocketWidthText: 8, rocketWidthAmbience: 5, 
        ambienceInterval: 30, partyInterval: 8, launchInterval: 1200 
    };
    const MAX_PARTICLES = 6000; // ç¨å¾®é™ä½ç²’å­æ•°ä»¥æé«˜æ‰‹æœºæµç•…åº¦

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const textCanvas = document.getElementById('textCanvas');
    const textCtx = textCanvas.getContext('2d');
    let cw = window.innerWidth;
    let ch = window.innerHeight;
    
    let fireworks = [];
    let particles = [];
    // é»˜è®¤æ’­æ”¾åˆ—è¡¨
    const SYSTEM_COUNTDOWN = ['10', '9', '8', '7', '6', '5', '4', '3', '2', '1'];
    const DEFAULT_MSG = ['2025', 'è›‡å¹´å¤§å‰', 'æ–°å¹´å¿«ä¹', 'ä¸‡äº‹å¦‚æ„']; 
    
    let playList = [];
    let currentIndex = 0;
    let lastTextLaunchTime = 0;
    let tick = 0;
    let isRunning = false;
    let isFinished = false;

    function resize() {
        cw = canvas.width = window.innerWidth;
        ch = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    window.toggleFullscreen = function() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => console.log(err));
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    };

    // --- ã€æ–°åŠŸèƒ½ã€‘URL å‚æ•°è¯»å– ---
    // è¿›å…¥é¡µé¢æ—¶ï¼Œè‡ªåŠ¨æ£€æŸ¥ç½‘å€é‡Œæœ‰æ²¡æœ‰ ?msg=...
    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const msg = params.get('msg');
        if (msg) {
            // å¦‚æœæœ‰å‚æ•°ï¼Œè§£ç å¹¶å¡«å…¥æ–‡æœ¬æ¡†
            const decodedMsg = decodeURIComponent(msg);
            document.getElementById('setup-text').value = decodedMsg;
            // æ›´æ–°æ ‡é¢˜æç¤ºç”¨æˆ·
            document.querySelector('.setup-title').innerText = "æ”¶åˆ°ä¸€ä»½çƒŸèŠ±ç¥ç¦";
        }
    }
    // é¡µé¢åŠ è½½å³è¿è¡Œ
    checkUrlParams();

    // --- ç²’å­ä¸çƒŸèŠ±é€»è¾‘ (ä¿æŒ V30 åŸæ±åŸå‘³) ---
    function getTextPoints(text) {
        textCanvas.width = cw;
        textCanvas.height = ch;
        textCtx.clearRect(0, 0, cw, ch);
        
        // å­—ä½“å¤§å°æ™ºèƒ½é€‚é…
        let baseSize = Math.min(cw * 0.22, 250); 
        if (text.length > 2) baseSize = Math.min(cw * 0.18, 200);
        if (text.length > 5) baseSize = Math.min(cw * 0.12, 150);
        
        textCtx.font = "bold " + baseSize + "px Arial, sans-serif";
        textCtx.fillStyle = '#ffffff';
        textCtx.textAlign = 'center';
        textCtx.textBaseline = 'middle';
        textCtx.fillText(text, cw / 2, ch / 3); 

        let imgData = textCtx.getImageData(0, 0, cw, ch).data;
        let points = [];
        let dynamicGap = CONFIG.gap;
        if (text.length > 4) dynamicGap = 3; 
        
        for (let y = 0; y < ch; y += dynamicGap) {
            for (let x = 0; x < cw; x += dynamicGap) {
                let i = (y * cw + x) * 4;
                if (imgData[i + 3] > 128) { 
                    points.push({x: x, y: y});
                }
            }
        }
        return points;
    }

    function random(min, max) { return Math.random() * (max - min) + min; }
    function getDistance(x1, y1, x2, y2) { return Math.sqrt(Math.pow(x1-x2, 2) + Math.pow(y1-y2, 2)); }

    class Firework {
        constructor(text, startX) {
            if (startX !== undefined) this.x = startX;
            else this.x = random(cw * 0.1, cw * 0.9);
            this.y = ch;
            this.tx = this.x + random(-20, 20);
            this.ty = random(ch * 0.1, ch * 0.35); 
            
            if (text) {
                this.x = cw / 2;
                this.tx = cw / 2;
                this.ty = ch / 3;
                this.speed = CONFIG.textRocketSpeed;
                this.textPayload = text;
                this.isTextRocket = true;
                this.lineWidth = CONFIG.rocketWidthText;
                this.hue = random(CONFIG.textBaseHue - 5, CONFIG.textBaseHue + 5);
                this.brightness = CONFIG.textBrightness;
            } else {
                this.speed = random(CONFIG.ambienceRocketMin, CONFIG.ambienceRocketMax);
                this.textPayload = null;
                this.isTextRocket = false;
                this.lineWidth = random(3, 6); 
                this.hue = random(0, 360);
                this.brightness = random(50, 80);
                this.explosionType = Math.floor(random(0, 3));
            }

            this.distToTarget = getDistance(this.x, this.y, this.tx, this.ty);
            this.distTraveled = 0;
            this.coordinates = [];
            this.coordinateCount = 3;
            while(this.coordinateCount--) this.coordinates.push([this.x, this.y]);
            this.angle = Math.atan2(this.ty - this.y, this.tx - this.x);
            this.acceleration = 1.015;
        }

        update(index) {
            this.coordinates.pop();
            this.coordinates.unshift([this.x, this.y]);
            this.speed *= this.acceleration;
            let vx = Math.cos(this.angle) * this.speed;
            let vy = Math.sin(this.angle) * this.speed;
            this.distTraveled = getDistance(this.x, this.y, this.x + vx, this.y + vy) + this.distTraveled;
            
            if (this.distTraveled >= this.distToTarget) {
                createParticles(this.tx, this.ty, this.textPayload, this.hue, this.explosionType);
                fireworks.splice(index, 1);
            } else {
                this.x += vx;
                this.y += vy;
            }
        }

        draw() {
            ctx.beginPath();
            ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
            ctx.lineTo(this.x, this.y);
            ctx.lineWidth = this.lineWidth;
            ctx.strokeStyle = `hsl(${this.hue}, 100%, 60%)`;
            ctx.stroke();
            ctx.lineWidth = 1;
        }
    }

    class Particle {
        constructor(x, y, hue, type, targetX, targetY, isNumber = false) {
            this.x = x;
            this.y = y;
            this.coordinates = [];
            this.coordinateCount = 5; // å‡å°‘æ‹–å°¾åæ ‡æ•°æå‡æ€§èƒ½
            while(this.coordinateCount--) this.coordinates.push([this.x, this.y]);
            
            this.hue = hue;
            this.alpha = 1;
            this.type = type;

            if (type === 'text') {
                this.x = targetX;
                this.y = targetY;
                this.vx = random(-0.8, 0.8);
                this.vy = random(-0.8, 0.8);
                this.friction = CONFIG.textFriction;
                this.gravity = 0.03;
                this.decay = isNumber ? random(0.025, 0.035) : random(0.010, 0.015);
                this.brightness = CONFIG.textBrightness;
            } else {
                let angle = random(0, Math.PI * 2);
                let speed = random(3, 15); 
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.friction = 0.96;
                this.gravity = 0.04;
                this.decay = random(0.015, 0.025);
                this.brightness = random(50, 80);
            }
        }

        update(index) {
            this.coordinates.pop();
            this.coordinates.unshift([this.x, this.y]);
            this.vx *= this.friction;
            this.vy *= this.friction;
            this.vy += this.gravity;
            this.x += this.vx;
            this.y += this.vy;
            this.alpha -= this.decay;
            if (this.alpha <= this.decay) particles.splice(index, 1);
        }

        draw() {
            ctx.beginPath();
            ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
            ctx.lineTo(this.x, this.y);
            ctx.lineWidth = (this.type === 'text') ? 3 : 2;
            
            if (this.type === 'text') {
                ctx.strokeStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`;
            } else {
                ctx.strokeStyle = `hsla(${this.hue}, 100%, 60%, ${this.alpha})`;
            }
            ctx.stroke();
        }
    }

    function createParticles(x, y, text, hue, type) {
        if (text) {
            let points = getTextPoints(text);
            let isNumber = !isNaN(text);
            if (particles.length > MAX_PARTICLES) return;
            let limit = 5000; 
            let step = Math.max(1, Math.ceil(points.length / limit));
            for(let i=0; i<points.length; i+=step) {
                particles.push(new Particle(x, y, hue, 'text', points[i].x, points[i].y, isNumber));
            }
        } else {
            let count = 100;
            while(count--) {
                particles.push(new Particle(x, y, hue, type, 0, 0));
            }
        }
    }

    // --- UI é€»è¾‘ ---
    const setupScreen = document.getElementById('setup-screen');
    const setupText = document.getElementById('setup-text');
    const setupMusic = document.getElementById('setup-music');
    const musicLabel = document.getElementById('music-label');
    const startBtn = document.getElementById('start-btn');
    const shareBtn = document.getElementById('share-btn');
    const bgm = document.getElementById('bgm');

    setupMusic.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            musicLabel.innerText = "âœ… " + file.name;
            bgm.src = URL.createObjectURL(file);
        }
    });

    startBtn.addEventListener('click', () => {
        initPlayList();
        if (bgm.src) {
            bgm.play().catch(e => console.log("éœ€äº¤äº’æ’­æ”¾"));
        }
        setupScreen.classList.add('hidden');
        isRunning = true;
        document.getElementById('status').innerText = "âœ¨ æ­£åœ¨æ’­æ”¾ç§äººå®šåˆ¶çƒŸèŠ± âœ¨";
    });
    
    // --- ã€æ–°åŠŸèƒ½ã€‘ç”Ÿæˆè½¬å‘é“¾æ¥ ---
    shareBtn.addEventListener('click', () => {
        const text = setupText.value.trim();
        if (!text) {
            alert("è¯·å…ˆè¾“å…¥ä¸€äº›ç¥ç¦è¯­ï¼");
            return;
        }
        
        // 1. è·å–å½“å‰ç½‘å€çš„åŸºç¡€éƒ¨åˆ† (å»æ‰ä¹‹å‰çš„é—®å·å‚æ•°)
        const baseUrl = window.location.origin + window.location.pathname;
        
        // 2. ç¼–ç ç”¨æˆ·è¾“å…¥çš„æ–‡å­—
        const encodedMsg = encodeURIComponent(text);
        
        // 3. æ‹¼æ¥æ–°é“¾æ¥
        const shareUrl = `${baseUrl}?msg=${encodedMsg}`;
        
        // 4. å¤åˆ¶åˆ°å‰ªè´´æ¿
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("âœ… é“¾æ¥å·²å¤åˆ¶ï¼\n\nè¯·ç›´æ¥å»å¾®ä¿¡å¯¹è¯æ¡†ç²˜è´´ï¼Œå‘é€ç»™æœ‹å‹ã€‚\næœ‹å‹ç‚¹å¼€å°±èƒ½çœ‹åˆ°ä½ å†™çš„å­—å•¦ï¼");
            });
        } else {
            // å…¼å®¹æ—§æµè§ˆå™¨æˆ–éHTTPSç¯å¢ƒ
            const textArea = document.createElement("textarea");
            textArea.value = shareUrl;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert("âœ… é“¾æ¥å·²å¤åˆ¶ï¼\n\nè¯·ç›´æ¥å»å¾®ä¿¡ç²˜è´´å‘é€ç»™æœ‹å‹ã€‚");
            } catch (err) {
                prompt("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹é“¾æ¥å‘é€ï¼š", shareUrl);
            }
            document.body.removeChild(textArea);
        }
    });

    window.showSetup = function() {
        setupScreen.classList.remove('hidden');
        isRunning = false; 
    };

    window.replay = function() {
        initPlayList();
        fireworks = [];
        document.getElementById('status').innerText = "âœ¨ é‡æ–°æ’­æ”¾ âœ¨";
    };

    function initPlayList() {
        const rawText = setupText.value.trim();
        currentIndex = 0;
        isFinished = false;
        if (rawText) {
            // å¦‚æœåªæœ‰ä¸€è¡Œï¼Œå°±åªæ”¾è¿™ä¸€è¡Œï¼›å¤šè¡Œåˆ™æŒ‰è¡Œæ’­æ”¾
            // æ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœç”¨æˆ·æ²¡å†™æ•°å­—å€’è®¡æ—¶ï¼Œæˆ‘ä»¬æ˜¯å¦å¼ºåˆ¶åŠ ï¼Ÿ
            // V30é€»è¾‘ï¼šå¦‚æœç¬¬ä¸€è¡Œä¸æ˜¯æ•°å­—ï¼Œåˆ™åŠ ä¸Šç³»ç»Ÿå€’è®¡æ—¶
            let userList = rawText.split('\n').filter(t => t.trim() !== '');
            if (isNaN(parseInt(userList[0]))) {
                playList = SYSTEM_COUNTDOWN.concat(userList);
            } else {
                playList = userList;
            }
        } else {
            playList = SYSTEM_COUNTDOWN.concat(DEFAULT_MSG);
        }
    }

    // --- åŠ¨ç”»å¾ªç¯ ---
    function loop() {
        requestAnimationFrame(loop);
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = `rgba(0, 0, 0, ${CONFIG.trail})`;
        ctx.fillRect(0, 0, cw, ch);
        ctx.globalCompositeOperation = 'lighter';

        let i = fireworks.length;
        while(i--) { fireworks[i].draw(); fireworks[i].update(i); }
        let j = particles.length;
        while(j--) { particles[j].draw(); particles[j].update(j); }

        if (particles.length > MAX_PARTICLES) {
            particles.splice(0, particles.length - MAX_PARTICLES);
        }

        if (!isRunning) return;

        let now = Date.now();
        tick++;
        if (!isFinished) {
            let waitTime = CONFIG.launchInterval;
            if (currentIndex >= 10) waitTime += 900; // å€’è®¡æ—¶ç»“æŸåç¨å¾®åœé¡¿ï¼Œå±•ç¤ºå¤§å­—

            if (now - lastTextLaunchTime > waitTime) { 
                if (currentIndex < playList.length) {
                    let text = playList[currentIndex];
                    fireworks.push(new Firework(text));
                    currentIndex++;
                    lastTextLaunchTime = now;
                } else {
                    isFinished = true; // æ’­æ”¾å®Œæ¯•ï¼Œè¿›å…¥è‡ªç”±æ¨¡å¼
                }
            }
            if (tick >= CONFIG.ambienceInterval) {
                // ç¯å¢ƒçƒŸèŠ± (ä¿æŒç”»é¢çƒ­é—¹)
                fireworks.push(new Firework(null, random(cw * 0.05, cw * 0.15)));
                fireworks.push(new Firework(null, random(cw * 0.85, cw * 0.95)));
                tick = 0;
            }
        } else {
            // è‡ªç”±æ¨¡å¼
            if (tick >= CONFIG.partyInterval) {
                let count = Math.floor(random(2, 4));
                for(let k=0; k<count; k++){
                    fireworks.push(new Firework(null, undefined));
                }
                tick = 0;
            }
        }
    }

    loop();

    // --- é¼ æ ‡/è§¦æ§äº¤äº’ (ä¿®å¤ç”µè„‘ç«¯ç‚¹ä¸åŠ¨çš„é—®é¢˜) ---
    function handleInput(x, y) {
        if (!isRunning) return; 
        fireworks.push(new Firework(null, x)); 
    }
    canvas.addEventListener('mousedown', (e) => handleInput(e.clientX, e.clientY));
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        for (let i = 0; i < e.touches.length; i++) {
            handleInput(e.touches[i].clientX, e.touches[i].clientY);
        }
    }, {passive: false});

</script>
</body>
</html>
